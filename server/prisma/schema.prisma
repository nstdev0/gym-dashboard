generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// --- ENUMS ---
enum Gender {
  MALE
  FEMALE
}

enum DocType {
  DNI
  PASSPORT
  CE
}

enum Role {
  OWNER
  ADMIN
  STAFF
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  CASH
  BANK_TRANSFER
  YAPE
  PLIN
  OTHER
}

enum MembershipStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  PAUSED
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  PARTIALLY_PAID
}

// --- MODELS ---

model Member {
  id Int @id @default(autoincrement())

  firstName String
  lastName  String
  gender    Gender?
  birthDate DateTime? @db.Date

  height Float?
  weight Float?

  docType   DocType
  docNumber String

  phoneNumber String?
  email       String? @unique

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  memberships Membership[]
  invoices    Invoice[]

  @@unique([docType, docNumber])
  // Índices para búsquedas rápidas
  @@index([firstName])
  @@index([lastName])
  @@index([isActive])
  @@map("members")
}

model User {
  id Int @id @default(autoincrement())

  role      Role
  firstName String
  lastName  String?
  username  String?  @unique
  email     String   @unique
  password  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Como un usuario puede emitir Y actualizar facturas, separamos las listas
  invoicesIssued  Invoice[] @relation("IssuedInvoices")
  invoicesUpdated Invoice[] @relation("UpdatedInvoices")

  @@map("users")
}

model Plan {
  id Int @id @default(autoincrement())

  name        String  @unique
  description String?

  price Decimal @db.Decimal(10, 2)

  isActive Boolean @default(true)

  durationInDays Int

  // Relaciones
  memberships Membership[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("plans")
}

model Membership {
  id Int @id @default(autoincrement())

  // Claves foráneas
  memberId Int
  planId   Int

  startDate DateTime @db.Date
  endDate   DateTime @db.Date

  status    MembershipStatus @default(ACTIVE)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relaciones
  member   Member    @relation(fields: [memberId], references: [id], onDelete: Restrict)
  plan     Plan      @relation(fields: [planId], references: [id], onDelete: Restrict)
  invoices Invoice[]

  @@map("memberships")
}

model Invoice {
  id Int @id @default(autoincrement())

  memberId     Int
  membershipId Int?

  amount Decimal @db.Decimal(10, 2)

  issuedAt DateTime @default(now())

  issuedBy  Int
  updatedBy Int?

  paidAt DateTime?

  status InvoiceStatus
  method PaymentMethod

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones con Usuario (Staff)
  user       User  @relation("IssuedInvoices", fields: [issuedBy], references: [id])
  userUpdate User? @relation("UpdatedInvoices", fields: [updatedBy], references: [id])

  // onDelete: Restrict -> Evita que borres un miembro si tiene facturas (seguridad contable)
  membership Membership? @relation(fields: [membershipId], references: [id], onDelete: Restrict)
  member     Member      @relation(fields: [memberId], references: [id], onDelete: Restrict)

  @@index([memberId])
  @@index([issuedAt])
  @@index([status])
  @@map("invoices")
}
