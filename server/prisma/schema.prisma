generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// --------------------------------------
// ENUMS
// --------------------------------------

enum Gender {
  MALE
  FEMALE
}

enum DocType {
  DNI
  PASSPORT
  CE
}

enum Role {
  OWNER
  ADMIN
  STAFF
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  CASH
  BANK_TRANSFER
  YAPE
  PLIN
  OTHER
}

enum MembershipStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  PAUSED
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  PARTIALLY_PAID
}

// --------------------------------------
// MODELS
// --------------------------------------

model User {
  id String @id @default(cuid())

  role      Role
  firstName String
  lastName  String?
  username  String? @unique
  email     String  @unique
  password  String
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELACIONES INVERSAS
  // Necesarias para que el modelo Invoice pueda conectar con User
  invoicesIssued  Invoice[] @relation("IssuedInvoices")
  invoicesUpdated Invoice[] @relation("UpdatedInvoices")

  @@map("users")
}

model Member {
  id String @id @default(cuid())

  firstName String
  lastName  String
  gender    Gender?
  birthDate DateTime? @db.Date

  // Datos físicos
  height Float?
  weight Float?

  // Identificación
  docType   DocType
  docNumber String

  // Contacto
  phoneNumber String?
  email       String? @unique
  address     String? // Para facturación

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELACIONES
  // Un miembro tiene un HISTORIAL de membresías (Array)
  memberships Membership[]

  // Un miembro tiene muchas facturas
  invoices Invoice[]

  // ÍNDICES Y CONSTRAINTS
  @@unique([docType, docNumber]) // No puede haber dos DNI iguales
  @@index([firstName, lastName]) // Búsqueda rápida por nombre completo
  @@index([isActive])
  @@map("members")
}

model Plan {
  id String @id @default(cuid())

  name        String  @unique
  description String?

  price Decimal @db.Decimal(10, 2)

  isActive       Boolean @default(true)
  durationInDays Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  memberships Membership[]

  @@map("plans")
}

model Membership {
  id String @id @default(cuid())

  // Claves Foráneas
  memberId String
  planId   String

  // Fechas de vigencia
  startDate DateTime @db.Date
  endDate   DateTime @db.Date

  status MembershipStatus @default(ACTIVE)

  // Snapshot del precio: Guardamos cuánto costó el plan en ESTE momento
  // por si el Plan sube de precio en el futuro.
  price Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  member   Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  plan     Plan      @relation(fields: [planId], references: [id], onDelete: Restrict)
  invoices Invoice[]

  @@index([memberId])
  @@index([status])
  @@map("memberships")
}

model Invoice {
  id String @id @default(cuid())

  // Opcional: Número de serie legible (Ej: F001-230)
  serialNumber String? @unique

  memberId     String
  membershipId String?

  amount Decimal @db.Decimal(10, 2)

  // Auditoría de fechas
  issuedAt DateTime  @default(now())
  paidAt   DateTime?

  // Auditoría de usuarios
  issuedBy  String
  updatedBy String?

  status InvoiceStatus
  method PaymentMethod

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELACIONES CON USUARIOS
  user       User  @relation("IssuedInvoices", fields: [issuedBy], references: [id])
  userUpdate User? @relation("UpdatedInvoices", fields: [updatedBy], references: [id])

  // RELACIONES DE NEGOCIO
  // Si borras una membresía, la factura NO se borra (SetNull), se mantiene por contabilidad.
  membership Membership? @relation(fields: [membershipId], references: [id], onDelete: SetNull)

  // No puedes borrar un miembro si tiene facturas (Restrict)
  member Member @relation(fields: [memberId], references: [id], onDelete: Restrict)

  @@index([memberId])
  @@index([issuedAt])
  @@index([status])
  @@map("invoices")
}
